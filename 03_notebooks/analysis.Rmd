---
title: Concurrent validity of an Estimator of Weekly Alcohol Consumption (EWAC) based
  on the Extended AUDIT
bibliography: bibliography.bib
csl: elsevier-vancouver.csl
output:
  pdf_document:
    citation_package: natbib
    df_print: kable
    fig_caption: yes
    keep_tex: yes
    number_sections: yes
    toc: yes
  word_document:
    toc: yes
    reference_docx: template.docx
  html_document:
    df_print: paged
    number_sections: yes
    toc: yes
link-citations: yes
always_allow_html: yes
---

<!--
ROC analysis
ROC power
fix tables
add HSE yesterday method

-->

<!-- 
abstract	250
intro	456
methods	
results	
discussion	858
conclu	100
total	1664

-->

<!-- # Abstract -->
<!-- *Background and Aims:* -->
<!-- *Design:* -->
<!-- *Setting:* -->
<!-- *Participants/Cases:* -->
<!-- *Measurements:* -->
<!-- *Findings:* -->
<!-- *Conclusions:* -->


```{r loading data, include=F}
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE)

# Loading data
source("../01_src/functions.R")
# source("../01_src/filepaths.R")
source("../01_src/audit_weights.R")


knit_output_pdf <- F
if(knit_output_pdf){
  options(knitr.table.format = "pdf")
} else {
  options(knitr.table.format = "pandoc")
}


library(tidyverse)
library(knitr)
library(captioner)
library(kableExtra)
library(pROC)
library(MASS)
# library("scales")
# library("xtable")
library(stargazer)

auditx_labels <- c("audit1_label", "audit2_label", "audit3_label")

load(file.path("..", "02_data", "HSE.rda"))
load(file.path("..", "02_data", "ATS.rda"))
# Too small a sample size too manage
ats$sex[ats$sex == "In another way"] <- NA
ats <- ats %>% 
  mutate(., 
    audit1_label = if_else(.$audit1_label %in% c("Refused", "Don't know"), 
                           NA_character_, audit1_label),
    audit2_label = if_else(.$audit2_label %in% c("Refused", "Don't know"), 
                           NA_character_, audit2_label),
    audit3_label = if_else(.$audit3_label %in% c("Refused", "Don't know"), 
                           NA_character_, audit3_label))

# Alcohol retail data from PHE 2017
alcohol_sales_2014_liters <- 361429387
alcohol_pcapita_adults_2014_units <-  16.3 # per capita for all population
alcohol_pcapita_drinker_2014_units <- 19.3 # per capita for drinkers only
MYPE_2014 <- 42724917 # population aged 18+

# Sample sizes
n_ats <- nrow(ats)
valid_n_study1a <-  nrow(na.omit(ats[, c("gfmeanweekly", "audit1", "audit2", "audit3")]))
valid_n_study1b <-  nrow(na.omit(dplyr::select(ats, audit1_label, audit2_label, audit3_label, gfmeanweekly,
                           sex, ageg7, ethgrp, religion, highqual, smokstat)))
valid_n_study1c <- nrow(na.omit(dplyr::select(
    filter(ats, auditc >= 5 | fullaudit >=8), 
    audit1_label, audit2_label, audit3_label, gfmeanweekly,
         sex, ageg7, ethgrp, favdrink, tryalclyc2, 
         religion, highqual, smokstat)))

table_nums <- captioner::captioner(prefix = "Table")
tab_comparison_schedules <- table_nums(
  name = "tab_comparison_schedules",
  caption = "Alcohol schedules: selective comparison")
tab_overview_datasets <- table_nums(
  name = "tab_overview_datasets",
  caption = "Description of data sources")
tab_ats_rmsd_quantiles <- table_nums(
  name = "tab_ats_rmsd_quantiles",
  caption = paste0("Percentiles of the absolute deviation between EWAC and GF schedule (n = ", valid_n_study1a, ")"))
tab_study1_roc <- table_nums(
  name = "tab_study1_roc",
  caption = paste0("Receiver operating characteristics of AUDIT-C score and EWAC for consumption >= 14 UK units/week (n = ", formatbm(valid_n_study1a), ")"))
tab_hosp_validity_reg <- table_nums(
  name = "tab_hosp_validity_reg",
  caption = "Coefficients of regression of TLFB daily consumption against EWAC, administration of the week, week day and time")
tab_aggregate_summary_stats <- table_nums(
  name = "tab_aggregate_summary_stats",
  caption = "Summary statistics on alcohol consumption in England in residents aged 18 years and over (excluding abstainers)")
tab_ewac_validity_reg <- table_nums(
  name = "tab_ewac_validity_reg",
  caption = paste0("Coefficients of linear regression of the bias and error of EWAC compared with GF in all respondents (n = ", formatbm(valid_n_study1b), ")"))
tab_ewac_validity_reg <- table_nums(
  name = "tab_ewac_validity_reg_increasedrisk",
  caption = paste0("Coefficients of linear regression of the bias and error of EWAC compared with GF in respondents with a hazardous/harmful alcohol use (AUDIT-C>=5 or AUDIT>=8; (n = ", formatbm(valid_n_study1c), ")"))


fig_nums <- captioner(prefix = "Figure")
fig_scatter_ats <- fig_nums(
  name = 'fig_scatter_ats',
  caption = 'Plots of EWAC against GF in (a) low/increasing risk ATS respondents (n=21,338) and (b) all ATS respondents (n=22,373)')
fig_ewac_MD_forest_plot <- fig_nums(
  name = 'fig_ewac_MD_forest_plot',
  caption = 'Forest plot of modelled MD for selected subgroups')
fig_ewac_RMSD_forest_plot <- fig_nums(
  name = 'fig_ewac_RMSD_forest_plot',
  caption = 'Forest plot of RMSD ratio (selected subgroups to reference category)')
fig_scatter_tlfb <- fig_nums(
  name = 'fig_scatter_tlfb',
  caption = 'Plot of EWAC estimates against TLFB estimates in hospital participants with lines of fit')
fig_ECDF<- fig_nums(
  name = 'fig_ECDF',
  caption = 'Empirical cumulative distribution function of weekly alcohol consumption in England according to four alcohol schedules in residents aged 18 years and over')


# Hospital data

load("../02_data/hospital.rda")
vname_audit_baseline <- c("audit1_bline", "audit2_bline", "audit3_bline")
vname_audit_fu <- c("audit1_fu", "audit2_fu", "audit3_fu")
qdata <- records$main 

# Compute AUDIT-C scores
qdata$auditc_score <- proc_AUDIT_score(
  qdata[,vname_audit_baseline], audit_weights_version3)
qdata$auditc_risk <- proc_AUDIT_risk(qdata$auditc_score)

# Compute EWAC
qdata$ewac_mp <- proc_EWAC(qdata[,vname_audit_baseline],
                           audit_weights_midpoints, method = "qfv")
qdata$ewac_stan <- proc_EWAC(qdata[,vname_audit_baseline],
                            audit_weights_STAN, method = "qfv" )
tdata_b <- records$tlfb %>%
  filter(encounter == "Baseline" &
           pid %in% unique(qdata$pid) &
           days_since <= 28)
tdata_b <- merge(tdata_b, qdata, by = "pid", all.x = T) %>% 
  filter(!is.na(ewac_stan))

hosp_miss <- tdata_b %>% 
  group_by(pid) %>% 
  summarise(n_missing = sum(is.na(alcunits)))


```


# Introduction

Globally, alcohol consumption is responsible for 5% of all deaths and disease disease @Shield2020. The burden of alcohol consumption goes far beyond the burden of *alcohol use disorders*, defined in the International Statistical Classification of Diseases (ICD-10 F10.1/F10.2; ICD-11 QE10/6C40.1). 

A number of strategies exist in order to prevent @NICE-PH24, or treat and reduce @NICE-CG115 harm from alcohol consumption. Some recommend systematic screening of alcohol use disorders using a validated diagnostic tool. More recently, others have advocated monitoring alcohol consumption like many other risk factors (eg body mass index or cholesterol), making individuals more conscious of their current intake and associated risk [@Nutt2014, @Rehm2016]. This approach is intended to promote timely behaviour change interventions (and, if necessary, pharmacological interventions) and prevent the emergence of alcohol use disorders. Recent public health recommendations to the public [@AU.alcoguidelines2009, @AlcoholCMO2016b] also now promote the idea of reducing consumption in the absence of a 'safe' level of alcohol consumption.

In contrast with alcohol use disorder screening tools, alcohol consumption assessment tools are not well embedded in clinical practice. Potential reasons include: lack of diagnostic validation, difficulty to self-assess alcohol consumption, and time pressures. This creates a gap in the range of resources destined to help individuals understand, monitor and take control of their alcohol consumption with--or without--the involvement of primary care physicians.

The objective of this paper is to develop and validate a fast and easy-to-complete Estimator of Weekly Alcohol Consumption (EWAC) by repurposing an existing screening tool. In many countries, the most widely used screening tool is the Alcohol Use Disorders Identification Test (AUDIT) [@Babor2001], a 10-item questionnaire schedule widely employed in clinical practice and clinical research as a diagnostic test for alcohol use disorder. The short, 3-item consumption version known as AUDIT-C has good diagnostics accuracy for both: (a) interview-based clinical diagnoses; and (b) consumption in excess of maximum recommended intakes (e.g. 140g/week in Australia, 112 g/week in UK) in a variety of populations [@DeMeneses-Gaya2009]. The present study aims to validate the AUDIT-C against continuous measures of alcohol consumption, as opposed to against a particular clinical diagnosis or consumption threshold.

To this end, we adopt a variant of the AUDIT-C schedule known as the ‘Extended AUDIT-C’, which improves the granularity of the information collected, thanks to a greater range of response options on quantity and frequency (items 1 and 2). The Extended AUDIT-C has been used in UK research as part of two trials [@Kaner2013c, @Crane2018] and one continuous household survey [@Beard2015a] to capture greater information on the higher risk drinkers, based on the observation that AUDIT consumption items are right-truncated.

This paper reports three distinct empirical studies. Study 1 estimates coefficients to apply to each of the AUDIT-C response items to compute an EWAC using data from a large English household survey, the Alcohol Toolkit Study (ATS). It then tests the concurrent validity of the EWAC across a number of demographic subpopulations in England. Study 2 tests the concurrent validity of the EWAC compared with the 28-day Timeline Followback in a clinical population (visitors of an acute hospital). Study 3 compares the population-wide total and empirical cumulative distribution of alcohol consumption in England using the EWAC, the ATS graduated frequency schedule, the Health Survey for England, and official statistics on alcohol sales.

# Methods

## Approach 

This paper develops and validates an Estimator of usual Weekly Alcohol Consumption in units (EWAC) based on the Extended AUDIT-C. Neither the AUDIT-C nor the Extended AUDIT-C provide a measure of usual alcohol consumption, but the product of frequency of drinking (AUDIT-C item 1) and quantity of drinking (AUDIT-C item 2) can be used to estimate usual alcohol consumption, with adjustment for occasional heavy use (AUDIT-C item 3), following methods developed for quantity-frequency-variability instruments [@Lemmens1992].

In practice, for every individual $i$, the EWAC is computed as the product of $F_i$ and $Q_i$ (AUDIT items 1 and 2 respectively) adjusted with the frequency of intense drinking $V_i$ (AUDIT item 3):

$$\text{EWAC}_i = F_i Q_i + V_ib$$

where $b$ denotes the average number of units of alcohol consumed in an intense drinking day. Coefficients $F, Q, V$ and $b$ are unknown. In this study, two sets of potential coefficients are evaluated:

- using the AUDIT response item interval midpoint: for example, 2.5 for '2 to 3 times per week' in AUDIT item 2
- using a statistical model to estimate the coefficients directly from gold standard data.

All results are reported in UK alcohol units (8g or 10mL of pure alcohol).  Analyses are conducted in `R` [@RCoreTeam2017] using packages `tidyverse`, `survey`, `rstan` [@package-tidyverse; @package-rstan; @package-survey; @Lumley2004]. Computer scripts for all analyses are available on an online repository @Dutey2020.

## Data sources

A longstanding obstacle in alcohol research and care is the absence of a diagnostic gold standard, which is not addressed even by the development of new biomarkers. Instead, a number of instruments exist which measure self-reported alcohol consumption with varying validity and reliability. A state-of-the art review from @Greenfield2000 is summarised in `r table_nums("tab_comparison_schedules", display = "cite")` below.

`r table_nums("tab_comparison_schedules")`

```{r table_comparison_schedules, fig.cap = tab_comparison_schedules, message=F}
readr::read_csv("table_overview_schedules.csv")  %>% 
  kable(., format = ifelse(knit_output_pdf, "latex", "html")) %>% 
  kable_styling()
```

Prospective diaries tend to record higher alcohol consumption by minimising recall bias, followed by GF, while lower levels seem to be recorded with QF measures [@Heeb2005, @Rehm1998]. 

The present paper employs four sources of data. An overview is available in `r table_nums("tab_overview_datasets", display = "cite")` below, together with references to publicly available methodological descriptions.

`r table_nums("tab_overview_datasets")`

|	Source	|	Time	|	Study population |	Measurements |	Validation	|	Sample size	|	Design	|
|	-------------	|	-------------	|	-------------	|	-------------	|	-------------	|	------:	|	-------------	|
|	Alcohol Toolkit Study (ATS) [@Beard2015a]	|	November 2015--October 2017 (waves 110--133)	|	Residents of private English households aged 16 years and over	|	Interviewer-led Extended AUDIT-C and GF	|	--	|	40,832	|	TBC	|
|	Health Survey for England (HSE) [@NatCenSocialResearch2013]	|	2011	|	Residents of private English households aged 18 years and over	|	Interviewer-led beverage-specific QF	|	This UK-specific schedule is consistent with a prospective diary [@Boniface2014] and yesterday recall [@Stockwell2016].	|	8,610	|	Multistage random sampling	|
|	Hospital questionnaire study (HOSP)	|	February 2019--October 2019	|	Outpatient and day case hospital patients aged 18 years and over	|	Interviewer/self-administered Extended AUDIT-C and interviewer-led TLFB	|	TLFB records fewer drinking days and thus lower consumption than a prospective diary [@Grant1995]. This recall bias increases with the number of days elapsed [@Hoeppner2010; @Vinson2003]	|	`r nrow(qdata)`	|	Cross-sectional recruitment with block randomisation to (a) self-administered AUDIT-C or (b) researcher-administered AUDIT-C.	|
|	Alcohol retail sales @PHE2017	|	2014	|	English population aged 18 years and over	|	--	|	@PHE2017	|	-- |	Ratio of all alcohol produced or processed in the UK, as well as alcohol imported into the UK for sale and consumption, over the mid-year population estimate	|


## Study 1: EWAC estimation and concurrent validity


Study 1 evaluates the accuracy of the EWAC derived from a researcher-administered Extended AUDIT-C in general household population. The gold standard is the GF schedule from the ATS data source. We compare two sets of coefficients: AUDIT response item interval midpoint; and coefficients estimated using a statistical model (detail reported in supplementary material).

First, the discrepancy between the EWAC and the GF schedule is quantified, by treating GF as a gold standard. It enables the examination of two types of deviations across every participant $i$ in the ATS sample:

- the mean deviation $\text{MD} = n^{-1} \sum_{i=1}^{n}{(\rm{EWAC}_i - \rm{GF}_i )}$ can be assimilated to a measure of bias under the assumption that GF is a gold standard. In this study, we test whether the MD is greater than 1 UK unit using a two-sided $t$-test. 
- the root mean squared deviation $\text{RMSD} = \sqrt{n^{-1} \sum_{i=1}^{n}{( \rm{EWAC}_i - \rm{GF}_i )^2}}$ can be assimilated to a measure of accuracy or total error: it capture both bias and random deviation from the assumed gold standard. For example, an RMSD of 2 signifies that the EWAC is on average with +/-2 UK units of the gold standard. In this study, we test the hypothesis that the RMSD is greater than 2 UK units using a one-sided $\chi^2$ homogeneity test.

Second, we examine whether the EWAC's validity varies across population subgroups.

- the simple deviation $(\text{EWAC}-\text{GF})$ is regressed in a linear model to test for subgroup differences in MD
- the squared deviation $(\rm{EWAC}-\rm{GF})^2$ is regressed in a log-transformed linear model to test subgroup differences in MSD. Model coefficients are transformed (exponential then square root transformations) in order to obtain the relative RMSD, that is, the ratio of RMSDs of the subgroup to the reference category. Both models include the following predictors: sex by age group; ethnic group; highest educational qualification; religion; smoking status. Additional models are estimated for respondents with an AUDIT-C score of 5 or more or an AUDIT score of 8 or more (under the ICD terminology, hazardous and harmful alcohol use), who provided additional information during the interview: favourite drink (beer; wine; spirits alone; mixed spirits; cider; other); and whether the respondent attempt to restrict alcohol intake in the last 12 months (eg by drinking less, choosing lower strength alcohol or using smaller glasses).

Third, we test whether the EWAC has equivalent or better predictive value in predicting drinking in excess of 14 UK units per week compared to the traditional AUDIT-C score. In the UK, a score of 5 or more is categorised as 'increasing risk' or 'higher risk', and regarded as indicating consumption in excess of 14 units per week. The study tests the hypothesis that the EWAC's receiver operating characteristics' area under the curve (AUC) is greater that the AUDIT-C score using a nonparametric paired AUC test @Delong1988.

The ATS data ($n=$ `r formatbm(n_ats)`) is affected by missing data: `r round(mean(ats$audit1 == 1)*100)`% of respondents ($n=$ `r formatbm(sum(ats$audit1 == 1))`) reported never drinking alcohol in AUDIT item 1 and were not asked any further AUDIT or GF questions. These participants are excluded from the analysis. A further `r formatbm(sum(ats$audit1 != 1 & is.na(ats$gfmeanweekly)))` respondents (`r tbrounding(sum(ats$audit1 != 1 & is.na(ats$gfmeanweekly))/sum(ats$audit1 != 1))`% of those reporting drinking in AUDIT item 1) did not have a valid GF alcohol consumption record and were also excluded. In total, `r formatbm(valid_n_study1a)` valid observations remain for the diagnostic analysis, in which missing GF data is assumed to be missing at random conditionally on the Extended AUDIT-C responses. In the subgroup analysis, a further `r tbrounding(valid_n_study1b/n_ats)`% (`r formatbm(valid_n_study1a-valid_n_study1b)`) repondents were assumed to have data missing at random and were excluded.
 
A pre-registered protocol for this study can be found in @Dutey2018. 


## Study 2: Concurrent validity in hospital outpatients

A second study aims to confirm the robustness of findings in (a) a patient population; (b) when the Extended AUDIT-C is self-administered; (c) using a different gold standard: the 28-day TLFB.

Participants were recruited from a range of clinics at a large acute hospital in Southampton, UK: orthopaedics outpatient, endoscopy day cases, young adult outpatient, infusion ???. Participants were randomised to one of two groups: 

(1) self-administered Extended AUDIT-C
(2) researcher-administered Extended AUDIT-C using block randomisation.

A total of `r nrow(qdata)` participants were recruited in hospital clinics, with data successfully collected on the Extended AUDIT-C for `r round(mean(!is.na(qdata$auditc_score))*100)`% of participants ($n$ = `r sum(!is.na(qdata$auditc_score))`). The Extended AUDIT-C was administered first, with `r nrow(filter(qdata, !is.na(auditc_score) & q_admin_mode == "Self"))` participants randomised to self-administration using a pen and paper form, while the remaining `r nrow(filter(qdata, !is.na(auditc_score) & q_admin_mode == "Researcher"))` were administered by a researcher. 

Once this first questionnaire completed, both groups were asked to complete a 28-day alcohol TFLB questionnaire administered by the researcher.

To model the relationship between the EWAC and the TLFB, the number of units consumed on any day was assumed to follow a negative binomial distribution, the rate of which is determined by the latent usual alcohol consumption as well as the following variables: AUDIT mode of administration (self-administered; researcher-administered), week day, number of days elapsed since (1-7; 8-14; 15-21; 22-28). TLFB daily number of units consumed were rounded to the nearest integer and regressed in a negative binomial regression model against the aforementioned predictor, as well as the EWAC divided by 7 to obtain its daily equivalent. The corresponding regression coefficient measures the ratio of TLFB to EWAC.


## Study 3: Aggregate concurrent validity

We examine the aggregate consistency in alcohol consumption estimates across all residents of England aged 18 years and over by plotting the empirical cumulative distribution of alcohol consumption given by (1) the EWAC estimated from the ATS; (2) the quantity-frequency estimated in the ATS; (3) the beverage-specific estimators in HSE in 2011; (4) the prospective diary estimator in HSE 2011. In this analysis, survey weights are used: in (1-3), poststratification weights estimated using calibration and age-sex MYPES; in (4), similar postratification weights adjusted for self-selection into participation to the prospective diary data collection. Finally, we examine the percentage of total alcohol sales for England accounted for by each method. Alcohol sales (both on-trade and off-trade) estimates for England (population aged 18 years and over) in 2014 were obtained from Public Health England [@PHE2017].


# Results

```{r}

ats$ewac_mp <- proc_EWAC(ats[, auditx_labels],
                           audit_coef = audit_weights_midpoints, method = "qfv")
ats$ewac_qf <- proc_EWAC(ats[, auditx_labels],
                           audit_coef = audit_weights_STAN, method = "qf")
ats$ewac_qfv <- proc_EWAC(ats[, auditx_labels],
                           audit_coef = audit_weights_STAN, method = "qfv")
ats$ewac_qb <- proc_EWAC(ats[, auditx_labels],
                           audit_coef = audit_weights_STAN, method = "qb")
ats$ewac_qv <- proc_EWAC(ats[, auditx_labels],
                           audit_coef = audit_weights_STAN, method = "qv")
ats$ewac_qfv_M <- proc_EWAC(ats[, auditx_labels],
                           audit_coef = audit_weights_STAN_men, method = "qfv")
ats$ewac_qfv_F <- proc_EWAC(ats[, auditx_labels],
                           audit_coef = audit_weights_STAN_women, method = "qfv")
ats <- mutate(ats, ewac_qfv_S = if_else(sex == "Men", 
                                        ewac_qfv_M, ewac_qfv_F))

ats$ewac_best <- data.frame(list(ats$gfmeanweekly - ats$ewac_qf, ats$gfmeanweekly - ats$ewac_qv, ats$gfmeanweekly - ats$ewac_qfv, ats$gfmeanweekly - ats$ewac_qb)) %>% 
  apply(., 1, function(X) if(length(which.min(abs(X)))==0) NA else which.min(abs(X))) 

ats$ewac_best<- factor(ats$ewac_best, labels = c("qf", "qv", "qfv", "qb"))


test_midpoint <- list(
  MD = mean(ats$ewac_mp - ats$gfmeanweekly, na.rm = T),
  MD.p = t.test.MD(ats$ewac_mp - ats$gfmeanweekly)$p.value,
  RMSD = sqrt(mean((ats$ewac_mp - ats$gfmeanweekly)^2, na.rm = T)),
  MSD = (mean((ats$ewac_mp - ats$gfmeanweekly)^2, na.rm = T)),
  MSD.ME = 1.96 * sqrt(var((ats$ewac_mp - ats$gfmeanweekly)^2, na.rm = T) / (
    length(na.omit(ats$ewac_mp - ats$gfmeanweekly))) - 1 ),
  RMSD.p = t.test( (ats$ewac_mp - ats$gfmeanweekly)^2, mu = 4)$p.value
)

test_stan <- list(
  MD = mean(ats$ewac_qfv - ats$gfmeanweekly, na.rm = T),
  MD.p = t.test.MD(ats$ewac_qfv - ats$gfmeanweekly)$p.value,
  MSD = (mean((ats$ewac_qfv - ats$gfmeanweekly)^2, na.rm = T)),
  MSD.ME = 1.96 * sqrt(var((ats$ewac_qfv - ats$gfmeanweekly)^2, na.rm = T) / (
  length(na.omit(ats$ewac_qfv - ats$gfmeanweekly))) - 1 ),
  RMSD = sqrt(mean((ats$ewac_qfv - ats$gfmeanweekly)^2, na.rm = T)),
  RMSD.p = chisq.test.variance( (ats$ewac_qfv - ats$gfmeanweekly)^2,
                                sigma = 4)$p.value
)

test_stan_S <- list(
  MD = mean(ats$ewac_qfv_S - ats$gfmeanweekly, na.rm = T),
  MD.p = t.test.MD(ats$ewac_qfv_S - ats$gfmeanweekly)$p.value,
  RMSD = sqrt(mean((ats$ewac_qfv_S - ats$gfmeanweekly)^2, na.rm = T)),
  RMSD.p = chisq.test.variance( (ats$ewac_qfv_S - ats$gfmeanweekly)^2,
                                sigma = 4)$p.value
)

stan_qfv_S_men <- ats %>% 
  filter(sex == "Men") %>% 
  summarise(MD = mean(ewac_qfv_S - gfmeanweekly, na.rm = T),
            MD.p = t.test.MD(ewac_qfv_S - gfmeanweekly)$p.value,
            RMSD = sqrt(mean((ewac_qfv_S - gfmeanweekly)^2, na.rm = T)),
            RMSD.p = chisq.test.variance((ewac_qfv_S - gfmeanweekly)^2,
                                         sigma = 4)$p.value) 
stan_qfv_S_women <- ats %>% 
  filter(sex == "Women") %>% 
  summarise(MD = mean(ewac_qfv_S - gfmeanweekly, na.rm = T),
            MD.p = t.test.MD(ewac_qfv_S - gfmeanweekly)$p.value,
            RMSD = sqrt(mean((ewac_qfv_S - gfmeanweekly)^2, na.rm = T)),
            RMSD.p = chisq.test.variance((ewac_qfv_S - gfmeanweekly)^2,
                                         sigma = 4)$p.value)

```

## Study 1: EWAC estimation and validation

### Overall bias and accuracy

The first step involved choosing a set of coefficients to compute the EWAC (see supplementary materials 1).

The EWAC computed with the midpoint of the AUDIT item intervals produces a mean deviation (MD) of `r tbrounding(test_midpoint$MD, 2)` UK alcohol units/week, indicating a bias inferior to the preregistered +/- 1-unit bias allowance (`r pvrounding(test_midpoint$MD.p)`). The root mean squared deviation (RMSD) estimate of `r tbrounding(test_midpoint$RMSD, 1)` units [95% CI: `r round(sqrt(test_midpoint$MSD - test_midpoint$MSD.ME), 1)`;`r round(sqrt(test_midpoint$MSD + test_midpoint$MSD.ME), 1)`] is significantly greater than the pre-registered 2-unit total error allowance (`r pvrounding(test_midpoint$RMSD.p)`), suggesting that the EWAC falls on average 12 units away from the GF gold standard.

Coefficients estimated empirically (statistical model reported in supplementary materials 2) provide a small improvement: MD = `r tbrounding(test_stan$MD, 2)` (`r pvrounding(test_stan$MD.p)`). Error remains statistically significantly greater than 2 (`r pvrounding(test_stan$RMSD.p)`) with RMSD = `r tbrounding(test_stan$RMSD, 1)` [95% CI: `r round(sqrt(test_stan$MSD - test_stan$MSD.ME), 1)`;`r round(sqrt(test_stan$MSD + test_stan$MSD.ME), 1)`].

The RMSD masks a dispersed and skewed error pattern. `r table_nums('tab_ats_rmsd_quantiles', display = "cite")` shows that, for 50% of participants, the EWAC falls within +/- 2 UK units of the GF weekly consumption estimate. In other terms, an interval estimate defined as the EWAC +/- 2 units (eg '10 to 14 units') would be accurate for half of individuals, while an interval estimate defined as the EWAC +/- 3 units (eg '9 to 15 units') would be accurate for 60% of individuals. 

`r table_nums('tab_ats_rmsd_quantiles')`

```{r ats_rmsd_quantiles}
as_tibble(t(round(quantile(na.omit(abs(ats$ewac_qfv - ats$gfmeanweekly)), probs = c(seq(.1, .9, .1), .95, .99)), 1)))
```


`r fig_nums("fig_scatter_ats", display = "cite")` compares individual EWAC and GF values. We note the departure of lines of best fit from the diagonal, demonstrating the EWAC's small but consistent positive bias (MD > 0). This discrepancy is more severe beyond 25 units per week.


```{r ewac_benchmark}
ats$ewac_qfv_bench <- ats$ewac_qfv * 0.8997 + 0.8344

stan_qfv_bench <- ats %>% 
  summarise(MD = mean(ewac_qfv_bench - gfmeanweekly, na.rm = T),
            RMSD = sqrt(mean((ewac_qfv_bench - gfmeanweekly)^2, na.rm = T)),
            RMSD.p = chisq.test.variance((ewac_qfv_bench - gfmeanweekly)^2,
                                         sigma = 4)$p.value)
```



```{r warning=F, fig.height=5, fig.width=10}
scatterplot_1 <- dplyr::select(ats, gfmeanweekly, ewac_qfv) %>% 
  na.omit %>% 
  ggplot(mapping = aes(x = gfmeanweekly, y = ewac_qfv)) +
  geom_point(alpha = .1) +
  geom_abline(aes(intercept = 0, slope = 1, col = "Identity", linetype = "Identity")) +
  geom_smooth(aes(col="OLS", linetype = "OLS"), method ='lm', formula=y~x) +
  geom_smooth(aes(col="Spline", linetype = "Spline"), 
              method = 'gam', formula = y~s(x, bs="ts")) +
  scale_colour_manual(name="Line of fit",
    values = c("Identity" = "black", "OLS" = "blue", "Spline" = "red")) +
  scale_linetype_manual(name="Line of fit",
    values = c("Identity" = "solid", "OLS" = "longdash", "Spline" = "dotted")) +
  ylab("EWAC (UK units/week)") +
  xlab("Graduated-Frequency schedule (UK units/week)") +
  coord_equal() +
  geom_hline(yintercept = 14, color = "grey50") + 
  geom_vline(xintercept = 14, color = "grey50") +
  theme_bw()

scatterplot_1b <- scatterplot_1 +
  geom_rect(aes(xmin = 0, ymin = 0, xmax = 36, ymax = 36), fill = "#faf207") +
  geom_point(alpha = .1)+
  scale_x_continuous(breaks = seq(0, 150, 10), limits = c(0, 150), minor_breaks = F)+
  scale_y_continuous(breaks = seq(0, 150, 10), limits = c(0, 150), minor_breaks = F)+
  ggtitle("(b)")

scatterplot_1a <- scatterplot_1 +
  theme(panel.background = element_rect(fill = "#faf207"),
        panel.grid = element_line(colour = "white")) +
 scale_x_continuous(breaks = seq(0, 150, 2), limits = c(0, 35), minor_breaks = F)+
 scale_y_continuous(breaks = seq(0, 150, 2), limits = c(0, 35), minor_breaks = F)+
  ggtitle("(a)")

ggpubr::ggarrange(scatterplot_1a, scatterplot_1b, ncol = 2, nrow = 1)
```

 `r fig_nums('fig_scatter_ats')`


### Subgroup accuracy

```{r ewac_subgroup_regressions}
ats <- mutate(ats, f_ageg = relevel(ageg7, ref = "25-34 years"))

lm_bias_stan <- lm((ewac_qfv-gfmeanweekly) ~ sex*f_ageg + ethgrp +  
                    religion + highqual  + smokstat, data = ats)
lm_rmsd_stan <- lm(log((ewac_qfv-gfmeanweekly)^2) ~ sex*f_ageg + ethgrp +  
                    religion + highqual + smokstat, data = ats)

```

Next, the MD and RMSD are regressed against respondents characteristics in order to identify subgroups with pronounced bias or total error (see supplementary materials 3, `r table_nums("tab_ewac_validity_reg", display = "cite")`). The model predictors explain a very modest proportion of both MD and RMSD ($R^2$ statistics < 2%). Nevertheless, specific subgroups do exhibit very different MD and RMSD.

`r fig_nums('fig_ewac_RD_forest_plot', display = "cite")` summarises the MD for a selection of subgroups whose predicted MD was either over 1 or under -1; and whose coefficients had a $p$-value under 0.05. The reference category's key characteristics are: females aged between 25 and 34 years of White ethnicity without educational qualifications, whose reported favourite drink was beer. Respondents of Black; Other; and White Other ethnic groups had significantly overestimated EWACs: their MDs were respectively 4.8 units [95% CI: 2.1, 7.5]; 5.9 units [1.6, 10.1] and 1.6 [0.2, 3.0] in excess of the reference MD. Respondents aged between 55 and 64 years or 75 years or more respectively had MDs 2.2 units [0.5; 3.9] and 4.2 units [0.9; 7.6] in excess of the reference MD. Evidence of milder--this time negative--bias was also found in respondents reporting any religion other than a Christian or Muslim faith.

```{r ewac_subgroup_bias, fig.width=7, fig.height=3}
ewac_bias_plot <- as_tibble(summary(lm_bias_stan)$coefficients)
ewac_bias_plot <- ewac_bias_plot %>% 
  mutate(Variable = names(lm_bias_stan$coefficients),
         MD = lm_bias_stan$coefficients[1] + Estimate) %>% 
  filter(abs(MD)>=1 & `Pr(>|t|)` < 0.05) %>% 
  arrange(-Estimate) %>% 
  mutate(x = rank(Estimate))
  
labs <- ewac_bias_plot$Variable
names(labs) <- as.character(length(labs):1)

ggplot(ewac_bias_plot, aes(x = factor(x), y = MD)) +
  scale_x_discrete(breaks = names(labs), 
                   labels = labs, name = NULL)+
  scale_y_continuous(breaks = -10:16, name = "Predicted MD (UK units/week)")+
  coord_flip() +
  geom_linerange(aes(ymin = MD - 1.96*`Std. Error`, ymax = MD + 1.96*`Std. Error`), 
                 colour = "purple") +
  geom_point() +
  geom_text(aes(label = round(MD, 1)), vjust = 1.2) +
  geom_hline(aes(yintercept = 0)) +
  geom_segment(aes(x = "0", xend = "0", y =0, yend = 2), 
               lwd = 1, arrow = arrow(length = unit(0.03, "npc"))) +
  geom_label(aes(x = "0", y = 2.1, label = "EWAC overestimates consumption"),
             hjust = "inward", colour = "purple") +
  theme_minimal() 

```

`r fig_nums('fig_ewac_MD_forest_plot')` 

Similarly, we sought to identify subgroups in which agreement between the EWAC and the GF gold standard was substantially different. `r fig_nums('fig_ewac_RMSD_forest_plot', display = "cite")` shows those subgroups with an RMSD found to be significantly different from the rest of the population ($p < 0.05$); and estimated to be 20% greater or smaller than the RMSD of the reference category. 

Error is significantly greater in mean (those reporting any religion other than Christian or Muslim; and in current smoker compared to never-smokers. 


```{r ewac_subgroup_error, fig.width=9, fig.height=3}
ewac_error_plot <- as_tibble(summary(lm_rmsd_stan)$coefficients)
ewac_error_plot <- ewac_error_plot %>% 
  mutate(Variable = names(lm_rmsd_stan$coefficients),
         MSD_ratio = exp(Estimate)) %>% 
  mutate(MSD_ratio_LB = exp(Estimate - (1.96*`Std. Error`)),
         MSD_ratio_UB = exp(Estimate + (1.96*`Std. Error`))) %>% 
  filter(abs(Estimate)>=log(1.2^2) & `Pr(>|t|)` < 0.05 & Variable != "(Intercept)") %>% 
  arrange(-MSD_ratio) %>% 
  mutate(x = formatC(rank(MSD_ratio)+1, width = 2, format = "d", flag = "0"))
  
labs2 <- ewac_error_plot$Variable
names(labs2) <- as.character(ewac_error_plot$x)

ggplot(ewac_error_plot, aes(x = factor(x), y = sqrt(MSD_ratio))) +
  scale_x_discrete(breaks = names(labs2), 
                   labels = labs2, name = NULL)+
  scale_y_continuous(breaks = seq(0, 4, .1),
                     "Relative RMSD (1.0 = reference category)")+
  coord_flip() +
  geom_text(aes(label = round(sqrt(MSD_ratio), 1)), vjust = 1.2) +
  geom_linerange(aes(ymin = sqrt(MSD_ratio_LB), ymax = sqrt(MSD_ratio_UB)), colour = "purple") +
    geom_point() +
  geom_hline(aes(yintercept = 1)) +
  geom_segment(aes(x = "00", xend = "00", y =1, yend =1.25), 
               lwd = 1, arrow = arrow(length = unit(0.03, "npc"))) +
  geom_label(aes(x = "00", y = 1.01, label = "Worse agreement of EWAC\n with gold standard"),
             hjust = "inward", vjust= -0.2, colour = "purple") +
  theme_minimal() 
```

`r fig_nums('fig_ewac_RMSD_forest_plot')`

In addition, respondents who attempted to reduce their alcohol consumption in the last year also had a higher RMSD. On the contrary, educational qualifications seem to significantly improve the agreement between EWAC and the gold standard. The RMSD is reduced by an average 2 units with an educational qualification compared to no qualifications (and without effect on MD), suggesting that respondents may have better recall and clarity over alcohol beverage content.



```{r}
lm_bias_increasingrisk <- lm((ewac_qfv-gfmeanweekly) ~ sex*f_ageg + ethgrp + favdrink + 
                   tryalclyc2 + religion + highqual  + smokstat, 
                   data = filter(ats, auditc >= 5 | fullaudit >=8))
lm_rmsd_increasingrisk <- lm(log((ewac_qfv-gfmeanweekly)^2) ~ sex*f_ageg + ethgrp + favdrink + 
                   tryalclyc2 + religion + highqual + smokstat, 
                   data = filter(ats, auditc >= 5 | fullaudit >=8))

```



### Receiver Operating Characteristics

```{r, roc_compute, message=F}

roc_auditc <- roc(gfmeanweekly>=14 ~ auditc, data = ats)  
roc_ewac <- roc(gfmeanweekly>=14 ~ ewac_qfv, data = ats)

roc_results <- list()
roc_results$auditc <- as_tibble(list(
  Metric = "AUDIT-C score",
  AUC = as.numeric(auc(roc_auditc)),
  `95% CI` = paste0("[", round(as.numeric(ci(auc(roc_auditc)))[1], 3), "; ",
                    round(as.numeric(ci(auc(roc_auditc))), 3)[3], "]"),
  `Best threshold` = coords(roc_auditc, "b", transpose = F)$threshold,
  Sensitivity = coords(roc_auditc, "b", transpose = F)$sensitivity,
  Specificity = coords(roc_auditc, "b", transpose = F)$specificity
))
roc_results$ewac <- as_tibble(list(
  Metric = "EWAC",
  AUC = as.numeric(auc(roc_ewac)),
  `95% CI` = paste0("[", round(as.numeric(ci(auc(roc_ewac)))[1], 3), "; ",
                    round(as.numeric(ci(auc(roc_ewac))), 3)[3], "]"),
  `Best threshold` = coords(roc_ewac, "b", transpose = F)$threshold,
  Sensitivity = coords(roc_ewac, "b", transpose = F)$sensitivity,
  Specificity = coords(roc_ewac, "b", transpose = F)$specificity
))
roc_results <- bind_rows(roc_results) %>% 
  mutate(AUC = round(AUC, 3),
         `Best threshold` = round(`Best threshold`, 3),
         Sensitivity = round(Sensitivity, 3),
         Specificity = round(Specificity, 3))
roc_ewac_nominal14 <- coords(roc_ewac, 14, transpose = F)
```

*Note*: The best threshold refers the cut-off value that maximises the sum of sensitivity and specificity.

The last step of this analysis was to examine the EWAC's ability to classify participants' consumption as being equal or in excess of 14 UK units/week. In comparison with the AUDIT-C score, EWAC increases the area under the curve by 5 percentage points (`r table_nums("tab_study1_roc", display = "cite")`), a statistically significant improvement (`r pvrounding(roc.test(roc_auditc, roc_ewac, method = "delong")$p.value)`). ROC curve are available from Supplementary Material 3. The cut-off that maximises the sum of specificity and sensitivity is 9.95 units/week. In constrast, using the nominal cut-off of 14 units/week yields a sensitivity of `r round(roc_ewac_nominal14$sensitivity, 3)` and a specificity of `r round(roc_ewac_nominal14$specificity, 3)`.

In summary, using an EWAC threshold of 10 units or more over an AUDIT-C score of 5 or more provides equivalent sensitivity, but with an a steep gain in specificity of 13 percentage points.


`r table_nums('tab_study1_roc')`

```{r tab_roc}
roc_results %>% kable
```




## Study 2: Concurrent validity in hospital patients

This study collected TLFB daily alcohol consumption from a total of `r sum(!is.na(qdata$auditc_score))` participants, of whom 63 were classified as low-risk drinkers, 25 as increasing-risk alcohol users (AUDIT-C score of 5 to 7), and 17 as high-risk alcohol users (AUDIT-C score of 8 or more). A total of `r as.numeric(summarise(filter(tdata_b, is.na(alcunits)), n_distinct(pid)))` participants did not provide TLFB information for at least one day missing out of 28, resulting in `r round(mean(is.na(tdata_b$alcunits))*100, 0)`% (`r sum(is.na(tdata_b$alcunits))`/`r nrow(tdata_b)`) of TLFB days were missing.


```{r }
tlfb_measured <- tdata_b %>% 
  group_by(pid) %>% 
  mutate(num_days = sum(!is.na(alcunits))) %>% 
  ungroup() %>% 
  filter(!is.na(alcunits) & !is.na(ewac_stan) & num_days >= 7) %>% 
  dplyr::select(pid, q_admin_mode, ewac_stan, alcunits) %>% 
  group_by(pid, ewac_stan) %>% 
  summarise(tlfb_units = mean(alcunits, na.rm = T)*7)
  
tlfb_descriptives <- list(
  MD = mean(tlfb_measured$ewac_stan - tlfb_measured$tlfb_units),
  MD.p = t.test(tlfb_measured$ewac_stan - tlfb_measured$tlfb_units)$p.value,
  RMSD = sqrt(mean((tlfb_measured$ewac_stan - tlfb_measured$tlfb_units)^2, na.rm = T)),
  MSD = mean((tlfb_measured$ewac_stan - tlfb_measured$tlfb_units)^2, na.rm = T),
  MSD.ME = 1.96 * sqrt(var((tlfb_measured$ewac_stan - tlfb_measured$tlfb_units)^2) / 
                         (nrow(tlfb_measured) - 1)),
  RMSD.p = chisq.test.variance( (tlfb_measured$ewac_stan - tlfb_measured$tlfb_units)^2,
                                sigma = 4)$p.value
)  
```  

Using only 103 participants with a minimum of 7 days recorded on the TLFB, MD is estimated at `r tbrounding(tlfb_descriptives$MD)` unit/week, which does not provide any evidence of bias greater than 1 unit/week (`r pvrounding(tlfb_descriptives$MD.p)`). As for error, RMSD is estimated at `r tbrounding(tlfb_descriptives$RMSD)` [95%CI: `r tbrounding(sqrt(tlfb_descriptives$MSD - tlfb_descriptives$MSD.ME))`; `r tbrounding(sqrt(tlfb_descriptives$MSD + tlfb_descriptives$MSD.ME))`] and is statistically significantly greater than 2 units (`r pvrounding(tlfb_descriptives$RMSD.p)`). A potential reason for RMSD being considerably smaller than in Study 1 is the distribution of alcohol consumption of this small pilot dataset. Respondents' alcohol intake as estimated by TLFB was low, with a mean of 7 units/week; a median of 2 units/week, and a 90th percentile of 23 units/week. Consequently, the probability of observing the strong deviations that can be observed in presence of high alcohol consumption data was low.


```{r warning=F, message = F, fig.height=5, fig.width=7}

ggplot(tlfb_measured, aes(y = ewac_stan, x = tlfb_units)) +
  geom_point() +
  geom_abline(aes(intercept = 0, slope = 1, col = "Identity", linetype = "Identity")) +
  geom_smooth(aes(col="OLS", linetype = "OLS"), method ='lm', formula=y~x) +
  geom_smooth(aes(col="Spline", linetype = "Spline"), 
              method = 'auto') +
  scale_colour_manual(name="Line of fit",
    values = c("Identity" = "black", "OLS" = "blue", "Spline" = "red")) +
  scale_linetype_manual(name="Line of fit",
    values = c("Identity" = "solid", "OLS" = "longdash", "Spline" = "dotted")) +
  theme_bw() +
  ylab("EWAC (UK units/week)") +
  xlab("Crude TLFB sample mean (UK units/week)")+
  coord_equal() +
  scale_x_continuous(breaks = seq(0, 100, 2), limits = c(0, 44), minor_breaks = F) +
  scale_y_continuous(breaks = seq(0, 100, 2), limits = c(0, 44), minor_breaks = F) +
  geom_hline(yintercept = 14, color = "grey50") + 
  geom_vline(xintercept = 14, color = "grey50")

```

`r fig_nums('fig_scatter_tlfb')`


## Study 3: Empirical distribution functions
```{r}
# From this point onwards, only drinkers aged 18 years and over
hse_dk18 <- filter(hse, age >= 18 & dnnow == 1) # only those drinking 'at all these days'
ats_dk18 <- filter(ats, actage >= 18 & audit1 > 1) %>%  # not 'never' drinkers
  mutate(agg_qfv = ewac_mp)
# ats_dk18$gfmeanweekly > 0 ???
```


`r table_nums("tab_aggregate_summary_stats", display = "cite")` provides estimates of total alcohol consumption in adult resident of private households in England using four different estimators, and compares them with alcohol retail sales. The HSE schedules provide the highest estimates of alcohol consumption and coverage of sale statistics. The proposed EWAC estimates of total consumption are just `r trunc(mean(ats_dk18$agg_qfv, na.rm =T)/mean(hse_dk18$weektot, na.rm =T)*100)`% of a very reliable estimate, the HSE prospective diary.

`r fig_nums('fig_ECDF', display = "cite")` suggests that the EWAC, like the ATS GF it was estimated against, estimates a higher prevalence of low risk consumption (<= 14 units/week) and increased risk consumption than HSE. In contrast very high alcohol consumption (>= 50 units/week) is higher in HSE. This may be due to a combination of difference in sampling coverage, nonresponse bias, or measurement error in the alcohol schedules.

`r table_nums('tab_aggregate_summary_stats')`

| Study     | Mean (units/week)     | Median | Variance | N | % of alcohol sold |
| ----------| ---------------------:| --------:|--------:| ----: | -----:
| HSE beverage-specific QF      | `r tbrounding(mean(hse_dk18$totalwu, na.rm =T))`   | `r tbrounding(median(hse_dk18$totalwu, na.rm =T))`     | `r tbrounding(var(hse_dk18$totalwu, na.rm =T))` |  `r formatbm(sum(!is.na(hse_dk18$totalwu)))` | `r tbrounding(mean(hse_dk18$totalwu, na.rm =T)*100/alcohol_pcapita_drinker_2014_units)` |
| HSE prospective diary | `r tbrounding(mean(hse_dk18$weektot, na.rm =T))`   | `r tbrounding(median(hse_dk18$weektot, na.rm =T))`     | `r tbrounding(var(hse_dk18$weektot, na.rm =T))` |  `r formatbm(sum(!is.na(hse_dk18$weektot)))` |`r tbrounding(mean(hse_dk18$weektot, na.rm =T)*100/alcohol_pcapita_drinker_2014_units)` |
| ATS GF    | `r tbrounding(mean(ats_dk18$gfmeanweekly, na.rm =T))`   | `r tbrounding(median(ats_dk18$gfmeanweekly, na.rm =T))`   | `r tbrounding(var(ats_dk18$gfmeanweekly, na.rm =T))` |  `r formatbm(sum(!is.na(ats_dk18$gfmeanweekly)))` |`r tbrounding(mean(ats_dk18$gfmeanweekly, na.rm =T)*100/alcohol_pcapita_drinker_2014_units)` |
| ATS EWAC    | `r tbrounding(mean(ats_dk18$agg_qfv, na.rm =T))`   | `r tbrounding(median(ats_dk18$agg_qfv, na.rm =T))`   | `r tbrounding(var(ats_dk18$agg_qfv, na.rm =T))` |  `r formatbm(sum(!is.na(ats_dk18$agg_qfv)))` |`r tbrounding(mean(ats_dk18$agg_qfv, na.rm =T)*100/alcohol_pcapita_drinker_2014_units)` |
| Retail sales | `r tbrounding(alcohol_pcapita_drinker_2014_units)` | -- | -- | -- | --|



```{r}
# ggplot() + 
#   stat_ecdf(aes(agg_qfv, colour = "ATS EWAC"), data = ats_dk18, geom = "step") +
#   stat_ecdf(aes(gfmeanweekly, colour = "ATS GF"), data = ats_dk18, geom = "step") +
#   stat_ecdf(aes(totalwu, colour = "HSE QF"), data = hse_dk18, geom = "step") +
#   stat_ecdf(aes(weektot, colour = "HSE Diary"), data = hse_dk18, geom = "step") +
#   ylab("Empirical cumulative density") +
#   xlab("Average units/week") +
#   scale_y_continuous(breaks = seq(0, 1, .1)) +
#   scale_x_continuous(limits = c(1, 100), 
#                      breaks = seq(0, 500, 10),
#                      minor_breaks = seq(0, 500, 5)) +
#   geom_vline(xintercept = 14)
#   
```



```{r  echo=F, fig.height=5, fig.width=8}
library(latticeExtra)
library(scales)
xlims = c(-3, 153)
EWAC <- ecdfplot(na.omit(ats_dk18$agg_qfv),
                key= keyABH, panel = function(x, f.value = NULL, type = "s",
                                              groups = NULL, qtype = 7, ref = TRUE,...) {
                  panel.ecdfplot(x, f.value = NULL, type = "s",
                                 groups = NULL, qtype = 7,
                                 ref = TRUE,...)
                  panel.abline(v = 14)
                },
                xlim = xlims, col = alpha("orange", .7), lwd = 3, lty = 1,
                scales=list(cex=1.0), xlab = ecdfxlab, ylab = ecdfylab)

GF <- ecdfplot(na.omit(ats_dk18$gfmeanweekly),
                key= keyABH, panel = function(x, f.value = NULL, type = "s",
                                              groups = NULL, qtype = 7, ref = TRUE,...) {
                  panel.ecdfplot(x, f.value = NULL, type = "s",
                                 groups = NULL, qtype = 7,
                                 ref = TRUE,...)
                  panel.abline(v = 14)
                },
                xlim = xlims, col = alpha("black", .7), lwd = 3, lty = 1,
               scales=list(cex=1.0), xlab = ecdfxlab, ylab = ecdfylab)

HSE <- ecdfplot(na.omit(hse_dk18$totalwu),
                key= keyABH, panel = function(x, f.value = NULL, type = "s",
                                              groups = NULL, qtype = 7, ref = TRUE,...) {
                  panel.ecdfplot(x, f.value = NULL, type = "s",
                                 groups = NULL, qtype = 7,
                                 ref = TRUE,...)
                  panel.abline(v = 14)
                },
                xlim = xlims, col = alpha("red", .7), lwd = 1, lty = 1,
                scales=list(cex=1.0), xlab = ecdfxlab, ylab = ecdfylab)

HSEdiary <- ecdfplot(na.omit(hse_dk18$weektot),
                key= keyABH, panel = function(x, f.value = NULL, type = "s",
                                              groups = NULL, qtype = 7, ref = TRUE,...) {
                  panel.ecdfplot(x, f.value = NULL, type = "s",
                                 groups = NULL, qtype = 7,
                                 ref = TRUE,...)
                  panel.abline(v = 14)
                },
                xlim = xlims, col = alpha("red", .7), lwd = 2, lty = 2,
                scales=list(cex=1.0), xlab = ecdfxlab, ylab = ecdfylab)

HSEdiary + HSE +EWAC + GF

```

`r fig_nums('fig_ECDF')`



# Discussion

<!-- This paper adopted a QFV approach to compute the EWAC over arguably more direct approaches possible with the ATS, such as supervised machine learning or direct estimation of the mean alcohol consumption for every observed combination of Extended AUDIT-C responses. Although cumbersome, the deterministic nature of the QFV algorithm is meant to be easier to estimate with small training datasets. It is also easier to implement in relational databases employed in electronic record systems compared to many manchine learning techniques. -->


## Main findings

This paper examined the predictive capabilities of the Extended AUDIT in England. The Extended AUDIT is a variant of the AUDIT-C containing a choice of 6 response items to quantify drinking frequency, and 7 reponse items to quantify the average quantity consumed during any drinking day. The resulting EWAC estimates usual alcohol consumption with a mean precision of +/- 11 units/week when compared to the GF alcohol schedule, or +/- 5 units/week when compared to a 28-day TLFB in a sample of lower-risk alcohol users. Precision is consistent across age and gender. However, some groups deviate from this presci

but some current smokers

More 

## Strengths and limitations 


While retaining the AUDIT’s strengths such as speed, accuracy and international standardisation, the Extended AUDIT improves the granularity of the information collected on alcohol consumption. It follows the same schedule as the AUDIT, but provides a greater range of response options in the quantity and frequency items (questions 1 and 2). The Extended AUDIT has been used in UK research as part of the SIPS trial [10] and the Alcohol Toolkit Study [11] to capture greater information on the higher risk drinkers, based on the observation that consumption items are right-truncated.


To the best of our knowledge, this is the first paper to develop an EWAC using a well-accepted and fast alcohol questionnaire such as the AUDIT. We used the Extended AUDIT-C to address the AUDIT-C's right-truncation and estimate consumption even for heavy consumers.

We find that it is possible to provide an EWAC with a margin of error of XX units using gender-specific coefficients, with consistent results across the English population.

Much like we produced gender-specific coefficients, it would be possible to use age information to adjust coefficients.
is consitent with previous research suggesting  largest discrepancy is noted for individuals aged 85 years and over

Knowledge of alcohol beverage content remains insufficient in the UK. In the 2007 HSE, just 31% of frequent beer drinkers and 17% of frequent wine drinkers were not aware of the unit equivalence to their intake. These proportions were found to be even lower in all other drinkers. 


This study reports an extensive range of validation analyses on the EWAC's validity and reliability. Findings are valid for the general population of England, although they may not generalise to other populations excluded from our sampling frames, such as residents of communal and carceral institutions, homeless people, or migrant populations. Similarly, findings may not designated to small subpopulations with an atypical alcohol consumption, such as patients seeking care for conditions such as addition or alcohol liver disease.


## Limitations 

As noted previously, a low proportion of the population knows the alcohol content of what they drink in units. This may influence the reliability of AUDIT item 2 (quantity), particularly in cases when it is self-administered or administered without guidance on beverage alcohol content. In this paper, the AUDIT scheduled was administered by a researcher in all cases but XXX participants in study 3; and even those were given a showcard summarising the unit content of most popular beverages. 
<!-- During data collection, we recorded a frequent confusion with the AUDIT's item 1: some participants being confused as to whether the question refers to number of days in which alcohol has been consumed, or number of occasions on any given day. We believe this to be a common occurrence when the AUDIT is self-administered. -->

respondents who drank beer and those who drank wine at least once a week were much more likely to know how many units were in that drink than were those who seldom drank these drinks, but even so, a of the



drinking diary was given to all participants aged 18 and over who completed the main HSE interview and had had an alcoholic drink in the previous 12 months.



<!-- The ATS presents some limitations. First, the high levels of data missingness and the exclusion of respondents answering 'Never' in AUDIT item 1 constituted a high risk of introducing bias in Study 1. Second, there is to our knowledge no validation data available for the ATS graduated-frequency schedule. For these reasons, basing the EWAC on ATS alone would have been hazardous. Such inferential risks are nevertheless addressed in the present paper through Study 3, through data collected from a health care setting, which low levels of missingness, using a different alcohol schedule known to exhibit more variability, but lower bias. -->

<!-- - GF not missing at random. Impute the `r round(3883/(3883+22376)*100, 1)`% missing cases -->



## Is the EWAC good enough to be used?

Efforts to provide early interventions (identification and brief advice) to low-risk 

Huge efforts to embed alcohol behaviour change interventions, already shaping policy and clinical concepts and terminology [@Lavoie2010]. 

Our findings demonstrate that the mean deviation between EWAC and a more time-consuming alcohol schedule is XX (GF) and XX (TFLB). In other words, 95% of respondents' expected alcohol intake may be up to X units away from the EWAC. Other clinical parameters may be affected by similar uncertainty. For instance, blood pressure is highly variables and can be xx off using a single reading. 
Specific patient and public involvement is needed to understand how satisfactory this precision is. In the meantime, we argue that the EWAC can be useful to both clinicians and patients alongside established AUDIT-C thresholds: it can be used to engage a conversation around health risks of alcohol and recommendations to maintain consumption below 14 units in the UK. We also think it can be less stigmatising than a score in excess of 5, which can often be interpreted by patients as being labelled as alcohol dependent or problem drinker.

## What are the potential applications?

Important contributions by Nutt and Rehm invite us to reconsider alcohol care practice in favour of a more clinical approach. These authors argue that alcohol consumption should be treated like any other risk factor: blood pressure or cholesterol are frequently monitored by general physicians in a non stigmatising way and managed as well as possible. Similarly, Rehm and Nutt's view is that  individuals should know their consumption, and general practitioners should be able to engage with patients effectively in managing risks. Where lifestyle interventions are unsuccessful, pharmacological alternatives should be sought. All recommendations participate to a single goal: preventing the very emergence of alcohol harm, by which state treatment is often less successful. 

Supportive of their argument, we propose that the EWAC could be employed in routine clinical practice to feedback results from an AUDIT-C check and provide recommendations to all types of drinkers; encouraging low-risk drinkers to maintain this lifestyle, and informing those close to 14 units or exceeding that limit that monitoring and controling alcohol consumption can be easy and improve long-term health. The EWAC can realistically only be computed by software and we have made such a calculator available online to this end: soton.ac.uk. It may be particularly suitable to digital intervention where personalised feedback can be generated as a function of not just mean alcohol consumption, but also intensity of alcohol consumption. For instance, some individuals drinking very rarely do so in large quantities in any given session. The EWAC and the AUDIT item 3 can be used to provide more relevant advice on consuming no more than 5 units in any given session. Study 3 showed in clinical population that the EWAC seemed to be as reliable when the Extended AUDIT-C is self-administered as when it is administered by a researcher. 
 
# Conclusion


# Ethics

Analysis of HSE and ATS microdata was approved by the University of Southampton's Faculty of Medicine Ethics Committee (ERGO 44682). The hospital questionnaire (Study 3) collection and analysis was approved by the Health Research Authority National Research Ethics Service (IRAS 247458; REC 18/SC/0564). 
 
# Supplementary materials

## Supplementary materials 1: EWAC coefficients (CSV file)

## Supplementary materials 2: Bayesian model report (PDF file)

## Supplementary materials 3: Subgroup analyses


`r table_nums('tab_ewac_validity_reg')`

```{r, results='asis'}
stargazer::stargazer(#lm_bias_mp, lm_rmsd_mp, 
          lm_bias_stan, lm_rmsd_stan, 
          type = ifelse(knit_output_pdf, "latex", "html"),
          ci = rep(T, 2),
          digits = 1, digits.extra	= 1, initial.zero = T, style = "ajs",
          single.row = T, intercept.bottom = F, align=TRUE, no.space= T,
          report = "vcs*")

```

`r table_nums('tab_ewac_validity_reg_increasedrisk')`

```{r, results='asis'}
stargazer::stargazer(#lm_bias_mp, lm_rmsd_mp, 
          lm_bias_increasingrisk, lm_bias_increasingrisk, 
          type = ifelse(knit_output_pdf, "latex", "html"),
          ci = rep(T, 2),
          digits = 1, digits.extra	= 1, initial.zero = T, style = "ajs",
          single.row = T, intercept.bottom = F, align=TRUE, no.space= T,
          report = "vcs*")

```
## Supplementary materials 3: ROC curves

```{r, fig.height=5, fig.width=7}
# roc_auditc$linetype <- "solid"
# roc_auditc$colour <- "#70ee9c"
# roc_ewac$linetype <- "longdash"
# roc_ewac$colour <- "#434371"

thresholds_auditc <- coords(roc_auditc, x = seq(2.5, 10.5, 1), 
                          input = "threshold", transpose = F)
thresholds_auditc$name <- "AUDIT-C score"
thresholds_auditc$`Cut-off` <- if_else(thresholds_auditc$threshold == 4.5, 
                                  "Max sens. & spec.", "Other")
thresholds_ewac <- coords(roc_ewac, x = c(8, 10, 12), 
                          input = "threshold", transpose = F) 
thresholds_ewac$name <- "EWAC"
thresholds_ewac$`Cut-off` <- if_else(thresholds_ewac$threshold == 10, 
                                  "Max sens. & spec.", "Other")
ggroc(list("AUDIT-C score" = roc_auditc, "EWAC" = roc_ewac), 
      aes=c("linetype", "colour")) + 
  geom_point(mapping = aes(x = specificity, y = sensitivity, shape = `Cut-off`),
             data = bind_rows(thresholds_auditc, thresholds_ewac),
             size = 2.5, stroke = 1.2, col = "black") +
  scale_shape_manual(values = c(4, 1) ) +
  geom_text(data = bind_rows(thresholds_auditc, thresholds_ewac),
            aes(x = specificity, y = sensitivity, label = threshold),
            hjust= -0.2, vjust = -0.2)
  
  
 
```



# Appendix hospital study


Sample size was set to power three statistical hypotheses listed in @Dutey2018. An internal pilot conducted on 130 participants was used to obtain estimates of the variance in MD. The study was powered to detect a minimum MD between EWAC and TLFB of 1 unit. Using a two-sided paired *t*-test, 80% power and 95% confidence, the required sample size was `r trunc(power.t.test(delta = 1, sd = 7, power = .8, sig.level = .05, type = "paired")$n)+1` in total. In addition, the study was powered to detect a minimum RMSD greater than $\text{RMSD}_{H_0} = 2$ units using a one-sided, one-sample $\chi^2$ test of variance. This involves testing the null hypothesis, $H_0: \text{RMSD}^2 = 4$ versus the one-sided alternative hypothesis $H_a: \text{RMSD}^2 > 4$. Dixon & Massey [@Dixon1983] set the minimum detectable value of the variance as $\text{RMSD}_{H_a}^2 = \text{RMSD}_{H_0}^2 .  \chi^2_{n-1, 1-\alpha} / \chi^2_{n-1, 1-\beta}$. With $n = 130$, $\alpha = 0.05$ and $\beta=.2$, $\text{RMSD}_{H_a} = 2.37$. The test statistic $\chi^2 = (n-1)\text{RMSD}^2 / 4$ follows a $\chi^2$ distribution with $n-1$ degrees of freedom. The normal approximation proposed by Dixon & Massey [@Dixon1983] to the sample size require is 
$$n = 1/2 \left( \dfrac{z_{1-\alpha}-z_\beta}{\ln(\text{RMSD}_{H_a}) - \ln(\text{RMSD}_{H_0})}\right)^2  $$

In our pilot study, the required sample size was `r  trunc(.5* ( ( qnorm(1-.05) -  qnorm(.2)) / log(sqrt(5.6304)/sqrt(4)) )^2) +1 `, that is inferior to the target pilot sample size.


# Tables


Table 1:  <a name="table_questionnaires"></a>Overview of alcohol schedule used in this paper.

<table style="width:100%;">
<colgroup>
<col width="20%">
<col width="80%">
</colgroup>
<thead>
<tr class="header">
<th>Survey module</th>
<th>Schedule</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><em>ATS QF module</em></td>
<td><ul>
<li>On how many days, if any, did you personally drink a drink containing alcohol in the last four weeks?</li>
<li>What was the maximum number of units you personally consumed on any one day when drinking an alcoholic drink or drinks in the last four weeks?</li>
<li>On how many days, if any, in the last four weeks did you personally drink… [prompting in turn &#39;51-60 units?&#39;, &#39;41-50 units?&#39;, …, &#39;1-2 units?</li>
</ul>
</tr>
<tr class="even">
<td align="center"><em>Health Survey for England</em></td>
<td><ul>
<li>Thinking now about all kinds of drinks, how often have you had an alcoholic drink of any kind during the last 12 months? <em>[8 items from &#39;Almost every day&#39; to &#39;Not at all in the last 12 months&#39;]</em></li>
<li>Did you have an alcoholic drink in the seven days ending yesterday?</li>
<li>On how many days out of the last seven did you have an alcoholic drink?</li>
<li>Which day last week did you last have an alcoholic drink/have the most to drink?</li>
<li>Thinking about last [answer to previous question], what types of drink did you have that day? [list of 8 types of alcohol beverages]</li>
<li>[running through each type of beverage and recording number of units drunk]</li>
</ul></td>

</tr>
</tbody>
</table>


# References